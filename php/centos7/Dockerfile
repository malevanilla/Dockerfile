# Version 0.0.1
FROM centos:7
MAINTAINER Alan Chu "malevanilla@gmail.com"

#Update
RUN yum update -y

#Install base package
RUN yum install -y git wget autoconf automake libtool re2c flex bison xml2lib-devel openssl-devel bzip2-devel libcurl-devel freetype-devel libjpeg.devel libpng-devel pam-devel libxslt-devel


#Clear package
RUN yum clean all

#Install imap
mkdir /home/src && cd /home/src
RUN wget ftp://ftp.cac.washington.edu/imap/imap-2007f.tar.gz
RUN tar -zxf imap-2007f.tar.gz
RUN cd imap-2007f
RUN make lr5 PASSWDTYPE=std SSLTYPE=unix.nopwd EXTRACFLAGS=-fPIC IP=4
RUN rm -rf /usr/local/imap-2007f/
RUN mkdir /usr/local/imap-2007f/
RUN mkdir /usr/local/imap-2007f/include/
RUN mkdir /usr/local/imap-2007f/lib/
RUN cp c-client/*.h /usr/local/imap-2007f/include/
RUN cp c-client/*.c /usr/local/imap-2007f/lib/
RUN cp c-client/c-client.a /usr/local/imap-2007f/lib/libc-client.a
RUN rm -rf /home/src/imap-2007f

#Git PHP
cd /home/src
RUN git clone -b PHP-7.1.0 https://github.com/php/php-src.git
RUN cd php-src

#make install
RUN ./buildconf
RUN ./configure \
		--prefix=/usr/local/php7 \
		--with-config-file-path=/usr/local/php7/etc \
		--enable-mbstring \
		--enable-fpm \
		--enable-opcache \
		--with-zlib-dir \
		--with-freetype-dir \
		--with-libxml-dir=/usr \
		--enable-soap \
		--enable-calendar \
		--with-curl \
		--with-zlib \
		--with-gd \
		--disable-rpath \
		--enable-inline-optimization \
		--with-bz2 \
		--with-zlib \
		--enable-sockets \
		--enable-sysvsem \
		--enable-sysvshm \
		--enable-pcntl \
		--enable-mbregex \
		--enable-exif \
		--enable-bcmath \
		--with-mhash \
		--enable-zip \
		--with-pcre-regex \
		--with-pdo-mysql \
		--with-mysqli \
		--enable-gd-native-ttf \
		--with-openssl \
		--with-libdir=/lib/x86_64-linux-gnu \
		--enable-ftp \
		--with-imap \
		--with-imap-ssl \
		--with-kerberos \
		--with-gettext \
		--with-xmlrpc \
		--with-xsl \
RUN make && make install

#Modify .conf|.ini file
#RUN sed -i "s/;date.timezone =.*/date.timezone = UTC/" /etc/php.ini && \
#    sed -i -e "s/;daemonize\s*=\s*yes/daemonize = no/g" /etc/php-fpm.conf && \
#    sed -i "s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/" /etc/php.ini && \
#    sed -i "s/short_open_tag = Off/short_open_tag = On/" /etc/php.ini && \
#    sed -i '/^listen = /clisten = 0.0.0.0:9000' /etc/php-fpm.d/www.conf && \
#    sed -i '/^listen.allowed_clients/c;listen.allowed_clients =' /etc/php-fpm.d/www.conf && \
#    sed -i '/^;catch_workers_output/ccatch_workers_output = yes' /etc/php-fpm.d/www.conf && \
#    sed -i "s/php_admin_flag\[log_errors\] = .*/;php_admin_flag[log_errors] =/" /etc/php-fpm.d/www.conf && \
#    sed -i "s/php_admin_value\[error_log\] =.*/;php_admin_value[error_log] =/" /etc/php-fpm.d/www.conf && \
#    sed -i "s/php_admin_value\[error_log\] =.*/;php_admin_value[error_log] =/" /etc/php-fpm.d/www.conf && \
#    echo "php_admin_value[display_errors] = 'stderr'" >> /etc/php-fpm.d/www.conf


EXPOSE 9000
CMD ["php-fpm"]
##</autogenerated>##
